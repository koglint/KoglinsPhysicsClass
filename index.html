<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title> Physics Progress </title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="container">

    <h1> HSC Physics </h1>
    <button onclick="window.open('cyu.html', '_blank')" class="cyu-button" id="cyuButton">Check Your Understanding (CYU) Questions</button>
    <h2 id="scopeHeading"> Scope and Sequence (Approximate) </h2>
    <img src="PHYSS.png" alt="Physics Scope and Sequence" class="top-banner">
    <h2 id="progressHeading"> Progress </h2>

    <!-- Legend for progress chart -->
    <div class="legend" style="display: none;">
      Started = Started the Learning Activities. <br>
      Completed = Finished all the Learning Activities. <br>
      Marked = Learning Activities marked using solutions or marking rubrics. <br>
      Mastered = All Learning Activities are completed with no errors.
    </div>

    <!-- Progress chart section -->
    <section id="progressChartContainer">
      <button id="toggleChartButton" onclick="toggleChartVisibility()">Collapse Chart</button>
      <h2>Module Progress</h2>
      <canvas id="progressChart"></canvas>
    </section>

    <div id="authStatus"><span id="statusIcon">Logged Out</span></div>

    <button id="authToggleButton" onclick="toggleAuthModal()">Login</button>

    <!-- Login Modal -->
    <div id="loginModal" class="auth-modal" style="display: none;">
      <h2>Login</h2>
      <input type="email" id="loginEmail" placeholder="Email" required>
      <input type="password" id="loginPassword" placeholder="Password" required>
      <button onclick="handleLogin()">Login</button>
      <p>Not registered yet? <a href="#" onclick="toggleRegisterModal()">Click here</a></p>
    </div>

    <!-- Register Modal -->
    <div id="registerModal" class="auth-modal" style="display: none;">
      <h2>Register</h2>
      <input type="email" id="registerEmail" placeholder="Email" required>
      <input type="password" id="registerPassword" placeholder="Password" required>
      <input type="text" id="registerFirstName" placeholder="First Name" required>
      <input type="text" id="registerLastName" placeholder="Last Name" required>
      <button onclick="handleRegister()">Submit</button>
    </div>

    <!-- Lesson Checklist Section -->
    <section id="taskChecklist" style="display:none;">
      <h2>Lesson Checklist</h2>
    </section>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
      import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
      import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
      import { lessonLinks, lessonData, lessonNames } from './lessonLinks.js';

      const firebaseConfig = {
        apiKey: "AIzaSyCCNFF9Au24okmKbH6ojbZB6xZIGddyo2U",
        authDomain: "koglinsphysicsclass.firebaseapp.com",
        projectId: "koglinsphysicsclass",
        storageBucket: "koglinsphysicsclass.appspot.com",
        messagingSenderId: "1051481871959",
        appId: "1:1051481871959:web:40bc24648d3a4f91f87512"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth();
      const db = getFirestore(app);

      // Set persistence and initialize listener
      setPersistence(auth, browserLocalPersistence)
        .then(() => initAuthListener())
        .catch((error) => console.error("Error setting persistence:", error));

      // Function to toggle the visibility of elements based on login status
      function updateStatus(isLoggedIn, userData = null) {
        const cyuButton = document.getElementById("cyuButton");
        const progressHeading = document.getElementById("progressHeading");
        const progressChartContainer = document.getElementById("progressChartContainer");

        if (isLoggedIn && userData) {
          cyuButton.style.display = "block";
          progressHeading.style.display = "block";
          progressChartContainer.style.display = "block";
          document.getElementById('authToggleButton').textContent = 'Logout';
        } else {
          cyuButton.style.display = "none";
          progressHeading.style.display = "none";
          progressChartContainer.style.display = "none";
          document.getElementById('authToggleButton').textContent = 'Login';
        }
      }

      // Attach the click event to authToggleButton
      document.getElementById('authToggleButton').addEventListener('click', () => {
        const authToggleButton = document.getElementById('authToggleButton');
        if (authToggleButton.textContent === 'Logout') {
          handleLogout();
        } else {
          toggleAuthModal();
        }
      });

      // Initialize auth listener to detect login state
      function initAuthListener() {
        onAuthStateChanged(auth, async (user) => {
          if (user) {
            const userData = await loadUserData(user.uid);
            if (userData) {
              updateStatus(true, userData);
              generateChecklist();
              await loadTaskProgress(user.uid);
            } else {
              updateStatus(false);
            }
          } else {
            updateStatus(false);
          }
        });
      }

      // Login function and other supporting functions go here...
    </script>
</div>
</body>
</html>
