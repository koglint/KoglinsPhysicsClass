<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Physics Progress</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="container">
    <h1>HSC Physics</h1>
    <button onclick="window.open('cyu.html', '_blank')" class="cyu-button" id="cyuButton" style="display:none;">Check Your Understanding (CYU) Questions</button>
    <h2 id="scopeHeading">Scope and Sequence (Approximate)</h2>
    <img src="PHYSS.png" alt="Physics Scope and Sequence" class="top-banner">
    <h2 id="progressHeading" style="display:none;">Progress</h2>

    <!-- Legend for progress chart -->
    <div class="legend" style="display: none;">
      Started = Started the Learning Activities. <br>
      Completed = Finished all the Learning Activities. <br>
      Marked = Learning Activities marked using solutions or marking rubrics. <br>
      Mastered = All Learning Activities are completed with no errors.
    </div>

    <!-- Progress chart section -->
    <section id="progressChartContainer" style="display:none;">
      <button id="toggleChartButton" onclick="toggleChartVisibility()">Collapse Chart</button>
      <h2>Module Progress</h2>
      <canvas id="progressChart"></canvas>
    </section>

    <div id="authStatus"><span id="statusIcon">Logged Out</span></div>

    <button id="authToggleButton" onclick="toggleAuthModal()">Login</button>

    <!-- Login Modal -->
    <div id="loginModal" class="auth-modal" style="display: none;">
      <h2>Login</h2>
      <input type="email" id="loginEmail" placeholder="Email" required>
      <input type="password" id="loginPassword" placeholder="Password" required>
      <button onclick="handleLogin()">Login</button>
      <p>Not registered yet? <a href="#" onclick="toggleRegisterModal()">Click here</a></p>
    </div>

    <!-- Register Modal -->
    <div id="registerModal" class="auth-modal" style="display: none;">
      <h2>Register</h2>
      <input type="email" id="registerEmail" placeholder="Email" required>
      <input type="password" id="registerPassword" placeholder="Password" required>
      <input type="text" id="registerFirstName" placeholder="First Name" required>
      <input type="text" id="registerLastName" placeholder="Last Name" required>
      <button onclick="handleRegister()">Submit</button>
    </div>

    <!-- Lesson Checklist Section -->
    <section id="taskChecklist" style="display:none;">
      <h2>Lesson Checklist</h2>
    </section>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
      import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
      import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
      import { lessonLinks, lessonData, lessonNames } from './lessonLinks.js';

      const firebaseConfig = {
        apiKey: "AIzaSyCCNFF9Au24okmKbH6ojbZB6xZIGddyo2U",
        authDomain: "koglinsphysicsclass.firebaseapp.com",
        projectId: "koglinsphysicsclass",
        storageBucket: "koglinsphysicsclass.appspot.com",
        messagingSenderId: "1051481871959",
        appId: "1:1051481871959:web:40bc24648d3a4f91f87512"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth();
      const db = getFirestore(app);

      setPersistence(auth, browserLocalPersistence)
        .then(() => initAuthListener())
        .catch((error) => console.error("Error setting persistence:", error));

      const cyuButton = document.getElementById("cyuButton");
      const progressChartContainer = document.getElementById("progressChartContainer");
      const progressHeading = document.getElementById("progressHeading");

      // Function to toggle the authentication modal
      function toggleAuthModal() {
        const loginModal = document.getElementById("loginModal");
        loginModal.style.display = loginModal.style.display === "none" ? "block" : "none";
      }

      // Function to show registration modal
      function toggleRegisterModal() {
        document.getElementById("loginModal").style.display = "none";
        document.getElementById("registerModal").style.display = "block";
      }

      async function handleLogin() {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        try {
          await signInWithEmailAndPassword(auth, email, password);
          toggleAuthModal();
          updateStatus(true);
        } catch (error) {
          alert("Login failed: " + error.message);
        }
      }

      async function handleRegister() {
        const email = document.getElementById("registerEmail").value;
        const password = document.getElementById("registerPassword").value;
        const firstName = document.getElementById("registerFirstName").value;
        const lastName = document.getElementById("registerLastName").value;

        try {
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          await saveUserData(userCredential.user.uid, firstName, lastName);
          alert(`Registration successful! Welcome ${firstName}`);
          toggleRegisterModal();
        } catch (error) {
          alert("Registration failed: " + error.message);
        }
      }

      async function saveUserData(uid, firstName, lastName) {
        try {
          await setDoc(doc(db, "users", uid), { firstName, lastName });
        } catch (error) {
          console.error("Error saving user data:", error);
        }
      }

      function updateStatus(isLoggedIn) {
        if (isLoggedIn) {
          document.getElementById("authToggleButton").textContent = "Logout";
          cyuButton.style.display = "inline";
          progressChartContainer.style.display = "block";
          progressHeading.style.display = "block";
        } else {
          document.getElementById("authToggleButton").textContent = "Login";
          cyuButton.style.display = "none";
          progressChartContainer.style.display = "none";
          progressHeading.style.display = "none";
        }
      }

      function initAuthListener() {
        onAuthStateChanged(auth, (user) => {
          if (user) {
            updateStatus(true);
          } else {
            updateStatus(false);
          }
        });
      }

      async function handleLogout() {
        try {
          await signOut(auth);
          alert("Logout successful!");
          updateStatus(false);
        } catch (error) {
          console.error("Error logging out:", error);
        }
      }
      
      document.getElementById("authToggleButton").addEventListener("click", () => {
        const authToggleButton = document.getElementById("authToggleButton");
        if (authToggleButton.textContent === "Logout") {
          handleLogout();
        } else {
          toggleAuthModal();
        }
      });
    </script>
</div>
</body>
</html>
